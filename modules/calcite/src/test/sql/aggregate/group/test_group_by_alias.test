# name: test/sql/aggregate/group/test_group_by_alias.test
# description: Test aliases in group by/aggregation
# group: [group]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE integers(ii INTEGER)

statement ok
INSERT INTO integers VALUES (1), (2), (3), (NULL)

# use alias in HAVING clause
# CONTROVERSIAL: this query DOES NOT work in PostgreSQL
query IR
SELECT ii % 2 AS kk, SUM(ii) FROM integers WHERE ii IS NOT NULL GROUP BY kk HAVING kk>0;
----
1	4.000000

# this is identical to this query
# CONTROVERSIAL: this query does not work in MonetDB
query IR
SELECT ii % 2 AS kk, SUM(ii) FROM integers WHERE ii IS NOT NULL GROUP BY kk HAVING ii%2>0;
----
1	4.000000

# select groups by constant (similar to order by constant)
query IR
SELECT ii % 2 AS kk, SUM(ii) FROM integers WHERE ii IS NOT NULL GROUP BY 1 HAVING ii%2>0;
----
1	4.000000

# constant out of range
statement error
SELECT ii % 2 AS kk, SUM(ii) FROM integers WHERE ii IS NOT NULL GROUP BY 42 HAVING ii%2>0;

# entry in GROUP BY should refer to base column
# ...BUT the alias in ORDER BY should refer to the alias from the select list
# note that both Postgres and MonetDB reject this query because of ambiguity. SQLite accepts it though so we do
# too.
query IIR
SELECT ii, ii % 2 AS ii, SUM(ii) FROM integers GROUP BY ii ORDER BY ii, 3;
----
NULL	NULL	NULL
2	0	2.000000
1	1	1.000000
3	1	3.000000

# changing the name of the alias makes it more explicit what should happen
query IIR
SELECT ii, ii % 2 AS kk, SUM(ii) FROM integers GROUP BY ii ORDER BY kk, 3;
----
NULL	NULL	NULL
2	0	2.000000
1	1	1.000000
3	1	3.000000

# this now orders by the actual grouping column
query IIR
SELECT ii, ii % 2 AS kk, SUM(ii) FROM integers GROUP BY ii ORDER BY ii;
----
NULL	NULL	NULL
1	1	1.000000
2	0	2.000000
3	1	3.000000

# cannot use GROUP BY column in an aggregation...
statement error
SELECT ii % 2 AS kk, SUM(kk) FROM integers GROUP BY kk

# ...unless it is one of the base columns
query IR
SELECT ii, SUM(ii) FROM integers GROUP BY ii ORDER BY ii
----
NULL	NULL
1	1.000000
2	2.000000
3	3.000000

# ORDER on aa non-grouping column
# this query is refused by Postgres and MonetDB
# but SQLite resolves it by first pushing aa "FIRST(ii)" aggregate into the projection, and then ordering by that
# aggregate
statement error
SELECT (10-ii) AS kk, SUM(ii) FROM integers GROUP BY kk ORDER BY ii;

# we can manually get this behavior by pushing FIRST
query IR
SELECT (10-ii) AS kk, SUM(ii) FROM integers GROUP BY kk ORDER BY FIRST(ii);
----
NULL	NULL
9	1.000000
8	2.000000
7	3.000000

