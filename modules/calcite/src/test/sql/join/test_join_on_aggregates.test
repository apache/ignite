# name: test/sql/join/test_join_on_aggregates.test
# description: Test join on aggregates
# group: [join]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE integers(ii INTEGER)

statement ok
INSERT INTO integers VALUES (1), (2), (3), (NULL)

# test join on ungrouped aggregates
query RR
SELECT * FROM (SELECT SUM(ii) AS x FROM integers) aa, (SELECT SUM(ii) AS x FROM integers) bb WHERE aa.x=bb.x;
----
6.000000	6.000000

# Test join on aggregates with GROUP BY
statement ok
CREATE TABLE groups(ii INTEGER, jj INTEGER)

statement ok
INSERT INTO groups VALUES (1, 1), (2, 1), (3, 2), (NULL, 2)

query IRII
SELECT aa.jj,aa.x,aa.y,bb.y FROM (SELECT jj, MIN(ii) AS y, SUM(ii) AS x FROM groups GROUP BY jj) aa, (SELECT jj, MIN(ii) AS y, SUM(ii) AS x FROM groups GROUP BY jj) bb WHERE aa.jj=bb.jj AND aa.x=bb.x ORDER BY aa.jj;
----
1	3.000000	1	1
2	3.000000	3	3

