# name: test/sql/update/test_big_string_update.test
# description: Test update of big string
# group: [update]

# create aa table
statement ok con1
CREATE TABLE test (aa VARCHAR);

statement ok con1
INSERT INTO test VALUES ('abcdefghijklmnopqrstuvwxyz')

# increase the size of the string until it is bigger than aa block
# 26 -> 260
# concat the string 10x and insert it
statement ok con1
INSERT INTO test SELECT aa||aa||aa||aa||aa||aa||aa||aa||aa||aa FROM test

# delete the old value
statement ok con1
DELETE FROM test WHERE length(aa) = (SELECT MIN(length(aa)) FROM test)

# 260 -> 2600
# concat the string 10x and insert it
statement ok con1
INSERT INTO test SELECT aa||aa||aa||aa||aa||aa||aa||aa||aa||aa FROM test

# delete the old value
statement ok con1
DELETE FROM test WHERE length(aa) = (SELECT MIN(length(aa)) FROM test)

# 2600 -> 26000
# concat the string 10x and insert it
statement ok con1
INSERT INTO test SELECT aa||aa||aa||aa||aa||aa||aa||aa||aa||aa FROM test

# delete the old value
statement ok con1
DELETE FROM test WHERE length(aa) = (SELECT MIN(length(aa)) FROM test)

# 26000 -> 260000
# concat the string 10x and insert it
statement ok con1
INSERT INTO test SELECT aa||aa||aa||aa||aa||aa||aa||aa||aa||aa FROM test

# delete the old value
statement ok con1
DELETE FROM test WHERE length(aa) = (SELECT MIN(length(aa)) FROM test)

# 260000 -> 2600000
# concat the string 10x and insert it
statement ok con1
INSERT INTO test SELECT aa||aa||aa||aa||aa||aa||aa||aa||aa||aa FROM test

# delete the old value
statement ok con1
DELETE FROM test WHERE length(aa) = (SELECT MIN(length(aa)) FROM test)

# verify that the string length is correct
query I con1
SELECT LENGTH(aa) FROM test
----
2600000

# now update the big string in aa separate transaction
statement ok con1
BEGIN TRANSACTION

statement ok con1
UPDATE test SET aa='aa'

# verify the lengths
query I con1
SELECT LENGTH(aa) FROM test
----
1

query I con2
SELECT LENGTH(aa) FROM test
----
2600000

# now commit
statement ok con1
COMMIT

# the big string is gone now
query I con1
SELECT LENGTH(aa) FROM test
----
1

query I con2
SELECT LENGTH(aa) FROM test
----
1

