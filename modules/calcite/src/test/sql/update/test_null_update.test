# name: test/sql/update/test_null_update.test
# description: Test standard update behavior with NULLs
# group: [update]

# create aa table
statement ok con1
CREATE TABLE test (aa INTEGER);

statement ok con1
INSERT INTO test VALUES (1), (2), (3), (NULL)

query I con1
SELECT * FROM test ORDER BY aa
----
NULL
1
2
3

# test updating from aa non-null value to aa null value
statement ok con1
BEGIN TRANSACTION

statement ok con1
UPDATE test SET aa=NULL WHERE aa=2

# not seen yet by con2, only by con1
query I con1
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
1
2
3

# commit
statement ok con1
COMMIT

query I con1
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

# now test aa rollback
statement ok con1
BEGIN TRANSACTION

statement ok con1
UPDATE test SET aa=NULL WHERE aa=3

# not seen yet by con2, only by con1
query I con1
SELECT * FROM test ORDER BY aa
----
NULL
NULL
NULL
1

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

statement ok con1
ROLLBACK

query I con1
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

# test updating from aa null value to aa non-null value
statement ok con1
BEGIN TRANSACTION

statement ok con1
UPDATE test SET aa=10 WHERE aa IS NULL

# not seen yet by con2, only by con1
query I con1
SELECT * FROM test ORDER BY aa
----
1
3
10
10

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

# now rollback
statement ok con1
ROLLBACK

# values are back to original values
query I con1
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

# perform the same update, but this time commit
statement ok con1
BEGIN TRANSACTION

statement ok con1
UPDATE test SET aa=10 WHERE aa IS NULL

query I con1
SELECT * FROM test ORDER BY aa
----
1
3
10
10

query I con2
SELECT * FROM test ORDER BY aa
----
NULL
NULL
1
3

statement ok con1
COMMIT

query I con1
SELECT * FROM test ORDER BY aa
----
1
3
10
10

query I con2
SELECT * FROM test ORDER BY aa
----
1
3
10
10

