# name: test/sql/subquery/exists/test_correlated_exists.test
# description: Test correlated exists
# group: [exists]

statement ok
PRAGMA enable_verification

statement ok
CREATE TABLE integers(i INTEGER)

statement ok
CREATE TABLE t1(a INTEGER, b INTEGER, c INTEGER, d INTEGER, e INTEGER, f INTEGER)

statement ok
INSERT INTO t1 VALUES (1, 2, 6, 4, 5, 6), (2, 3, 6, 5, 6, 7)

statement ok
INSERT INTO integers VALUES (1), (2), (3), (NULL)

query IIIIII
SELECT a+b*2,
       (a+b+c+d+e)/5,
       (SELECT count(*) FROM t1 AS x WHERE x.c>t1.c AND x.d<t1.d),
       (SELECT count(*) FROM t1 AS x WHERE x.b<t1.b),
       abs(b-c),
       a-b
  FROM t1
 WHERE EXISTS(SELECT 1 FROM t1 AS x WHERE x.b<t1.b)
   AND c>d
 ORDER BY 6,5,4,1,3,2
----
8	4	0	1	3	-1

# correlated EXISTS
query IT
SELECT i, EXISTS(SELECT i FROM integers WHERE i1.i>2) FROM integers i1 ORDER BY i NULLS FIRST;
----
NULL	false
1	false
2	false
3	true

query IT
SELECT i, EXISTS(SELECT i FROM integers WHERE i IS NULL OR i>i1.i*10) FROM integers i1 ORDER BY i NULLS FIRST;
----
NULL	true
1	true
2	true
3	true

# correlated EXISTS
query IT
SELECT i, EXISTS(SELECT i FROM integers WHERE i1.i>2) FROM integers i1 ORDER BY i NULLS FIRST;
----
NULL	false
1	false
2	false
3	true

query IT
SELECT i, EXISTS(SELECT i FROM integers WHERE i=i1.i) FROM integers i1 ORDER BY i NULLS FIRST;
----
NULL	false
1	true
2	true
3	true

query I
SELECT i FROM integers i1 WHERE EXISTS(SELECT i FROM integers WHERE i=i1.i) ORDER BY i;
----
1
2
3

# SUM on exists
query R
SELECT SUM(CASE WHEN EXISTS(SELECT i FROM integers WHERE i=i1.i) THEN 1 ELSE 0 END) FROM integers i1;
----
3.000000

query IT
SELECT i, EXISTS(SELECT i FROM integers WHERE i IS NULL OR i>i1.i*10) FROM integers i1 ORDER BY i NULLS FIRST;
----
NULL	true
1	true
2	true
3	true
